# 数据实时性方案：价格与货源信息

目标：让 RxLikewise 提供**尽可能实时、可预测**的价格与货源（短缺/可得性）信息，在合规与成本可控前提下形成差异化。

---

## 一、定义与边界

| 概念 | 含义 | 可实现程度 |
|------|------|------------|
| **实时** | 用户看到的数据在「分钟～小时」级更新 | 短缺：可做到日级；价格：依赖合作 API 或定时任务 |
| **可预测** | 给出合理区间或趋势（如「典型 $0–$50」「本周申诉成功率约 78%」） | 可用汇总数据 + 定期更新实现 |
| **货源** | 谁有货、哪里能开到药 | 真实库存需药房/合作方接口；短缺状态可由 FDA 支撑 |

---

## 二、数据源与可行性

### 1. 短缺（Supply / Shortage）

| 来源 | 更新频率 | 获取方式 | 备注 |
|------|----------|----------|------|
| **FDA Drug Shortages API** | 每日更新 | `GET https://api.fda.gov/drug/shortage.json`，无需 key（生产建议申请 key） | 当前已用：客户端直连 + 静态 fallback |

**最佳实践**：不依赖浏览器直连 FDA，改为**服务端定时拉取 → 写入 JSON/DB → 前端读自己的接口或静态文件**，保证每次用户看到的是「今日已更新」的数据。

### 2. 价格（Pricing）

| 来源 | 实时性 | 获取方式 | 备注 |
|------|--------|----------|------|
| **GoodRx API（B2B）** | 实时/近实时 | 申请 API Key，调用 Price Compare API（按药品、地区返回现金价/优惠价） | 需商务合作与签约，适合「真实比价」 |
| **厂商/药店公开价** | 周/月 | 人工或爬虫抓取 list price、折扣卡说明 | 法律与 ToS 需合规评估 |
| **自建参考区间** | 周/月 | 用公开信息维护「典型区间」（如 $0–$50 有保险、$150–$350 复合） | 当前做法，诚实标注「Data as of」即可 |
| **用户上报** | 持续 | 表单提交「我付了 $X、在 Y 药房、Z 日期」 | 需审核与展示策略，可作为补充 |

**最佳方案（有预算）**：接入 **GoodRx 或同类 B2B 定价 API**，按药品 + 邮编返回价格区间，再由你们展示或做「预估自付」；无 API 时用「参考区间 + 定期更新 + 用户上报」做可预测的区间。

### 3. 货源/可得性（Who has stock）

| 来源 | 实时性 | 获取方式 | 备注 |
|------|--------|----------|------|
| **FDA 短缺** | 日 | 见上 | 只能说明「是否短缺」，不能精确到「某药房有货」 |
| **药房/ telehealth 合作方** | 实时/近实时 | 合作方 API 或数据文件 | 需商务对接 |
| **用户上报** | 持续 | 「我在此药房/平台成功拿到某药」 | 可做成「近期成功案例」滚动，增强信任与粘性 |

**最佳方案**：短缺用 FDA；「哪里能买到」优先用合作方数据，其次用用户上报（带时间与地区），并明确标注来源与时间。

---

## 三、推荐架构（分层 + 缓存）

```
┌─────────────────────────────────────────────────────────────────┐
│  用户端（当前静态站 / 客户端）                                      │
│  - 读 /api/* 或 静态 JSON（定时生成）                              │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │
┌─────────────────────────────────────────────────────────────────┐
│  数据层（推荐：Vercel Serverless / 独立后端 / Cron）               │
│  - 定时拉取 FDA → 写 shortage.json 或 DB                          │
│  - 若有 GoodRx：代理请求或定时拉取 → 写 price cache                │
│  - 用户上报 → 写入 DB，审核后展示                                  │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │
┌─────────────────────────────────────────────────────────────────┐
│  外部源                                                           │
│  - FDA API（短缺）                                                │
│  - GoodRx / 其他 B2B 价格 API（若签约）                            │
│  - 合作药房/ telehealth（若对接）                                  │
└─────────────────────────────────────────────────────────────────┘
```

要点：

- **短缺**：服务端定时（如每日）拉 FDA → 生成 `public/data/shortage.json` 或通过 API 返回；前端只读自己的数据，避免 CORS 与限流。
- **价格**：有 API 则定时或按需拉取并缓存；无 API 则继续用「参考区间 + 定期维护 + 用户上报」。
- **货源**：合作方 API 或用户上报，经审核后展示「近期成功」等，并注明「用户反馈，仅供参考」。

---

## 四、落地步骤（按优先级）

### Phase 1：短缺「准实时」（无需新后端，仅改更新方式）

1. **定时任务更新 shortage**  
   - 用 **Vercel Cron**（需取消静态 export 或单独部署一个 cron 服务）或 **GitHub Actions** 每日调用 FDA API。  
   - 将结果写入 `public/data/shortage.json` 并 commit，或写入 Supabase/DB，由前端或一个简单 API 读取。  
2. **前端**  
   - 优先读「自己站点的 shortage 数据」（静态 JSON 或 `/api/shortage`），仅当失败时再 fallback 到当前逻辑。  
3. **效果**：用户看到的短缺信息为「每日更新」，不再依赖浏览器直连 FDA。

### Phase 2：价格「可预测」增强（无 GoodRx 时）

1. **统一数据出口**  
   - 在 `lib/` 或 CMS 维护「参考价格区间」与「数据日期」（如现有 `DATA_AS_OF`），首页、计算器、药品页共用。  
2. **可选：用户上报价格**  
   - 表单：药品、金额、保险/自费、药房/平台、日期。  
   - 审核后写入 DB，展示为「用户反馈区间」或「近期报价」，并注明来源与日期。  
3. **效果**：价格仍为「参考区间」，但更可预测、更可解释，且可持续积累真实数据。

### Phase 3：价格「实时」或近实时（有预算时）

1. **申请 GoodRx API**（或同类 B2B 定价 API）  
   - 见 [GoodRx Developer](https://www.goodrx.com/developer)，Price Compare API 支持按药品、地区等返回价格。  
2. **后端/Serverless**  
   - 提供例如 `GET /api/price?drug=wegovy&zip=77001`，后端调 GoodRx（或缓存 6–24h），返回给前端。  
3. **前端**  
   - 计算器或药品页「查价格」时请求上述 API，展示区间或最低价，并标注「来自合作方，仅供参考」。  
4. **效果**：价格从「静态区间」升级为「按地区/药品刷新的参考价」，实时性显著提升。

### Phase 4：货源/可得性（合作方 + 用户上报）

1. **合作方**  
   - 若与 telehealth 或药房有数据合作，接入「是否有货 / 是否可开方」等接口，在站内展示「Check Availability」结果或链接。  
2. **用户上报**  
   - 「我在此处成功拿到某药」的轻量表单，审核后展示为「近期成功案例」滚动条（如首页规划中的「社区与实时动态」）。  
3. **效果**：短缺仍由 FDA 支撑；「哪里能买到」由合作方 + 用户反馈共同支撑，并注明来源。

---

## 五、技术选型小结

| 需求 | 无/低预算 | 有预算 |
|------|------------|--------|
| **短缺** | 定时任务（Cron）拉 FDA → 写 JSON/DB，前端读自己的数据 | 同上 + 可选 CDN 缓存 |
| **价格** | 参考区间 + 定期更新 + 可选用户上报 | GoodRx（或同类）API + 缓存 + 用户上报 |
| **货源** | 用户上报「成功案例」+ 外链到合作方 | 合作方 API + 用户上报 |
| **部署** | 静态站 + Vercel Cron 或 GitHub Actions 写 JSON/DB | 静态站 + Serverless API（Vercel/Supabase Edge）代理/聚合 |

---

## 六、结论：最佳方案归纳

- **短缺**：**服务端定时拉取 FDA → 统一数据源（文件或 API）→ 前端只读本站**。这是成本最低、收益明显的「准实时」方案。  
- **价格**：**最佳方案为接入 GoodRx 或同类 B2B 定价 API**，通过你们自己的 API 按药品/地区返回并缓存（如 6–24h），前端展示「实时/近实时参考价」；在未接入前，用**参考区间 + 定期更新 + 用户上报**做「可预测」价格。  
- **货源**：**FDA 负责短缺维度**；「哪里能买到」最佳方案为**合作方数据 + 用户上报**，并明确标注来源与时间，避免误导。

整体上，先完成 **Phase 1（短缺定时更新）** 和 **Phase 2（价格可预测与用户上报）**，再视资源情况推进 Phase 3（GoodRx）和 Phase 4（合作方 + 用户货源），即可在合规与成本可控前提下，最大程度提升「实时、可预测的价格和货源信息」能力。

---

## 七、「三位一体」数据驱动系统（愿景与评价）

### 7.1 愿景归纳

在 2026 年背景下，仅靠人工更新无法满足实时与可预测性。建议构建**「三位一体」**数据体系：

| 支柱 | 内容 | 作用 |
|------|------|------|
| **官方 API** | FDA 短缺、CMS/医保政策等 | 基准与合规锚点 |
| **商业比价聚合** | GoodRx / SingleCare 等 B2B 价格 API | 按 ZIP、药品的近实时价格 |
| **众包实时反馈** | 用户上报「我在 X 处买到 / 付了 $Y」 | 最快、最贴近真实的「传感器」 |

**核心结论**：不要试图自己生产全部数据，而要成为数据的**「超级连接器」**。官方数据永远慢半拍，药房 API 并非对所有人开放，唯有真实用户是最快、最准的实时来源。

### 7.2 架构目标（与上文一致）

| 模块 | 来源 | 实时频率 | 作用 |
|------|------|----------|------|
| **价格引擎** | GoodRx / SingleCare / 药房直连 | 15–60 分钟 | 当前折后最低价、按 ZIP |
| **库存雷达** | 药房库存 API / 用户众包 | 5–10 分钟（众包）或按合作方 | 地图标注「哪里有药」 |
| **政策监测** | FDA / CMS 等 | 每日 | TrumpRx、报销规则对价格的影响 |
| **预测层** | 历史短缺 + 众包 + 可选 ML | 每日或按需 | 缺货风险指数、趋势 |

### 7.3 对你方案的直接评价

- **「三位一体」+ 超级连接器**：方向正确。把官方、商业 API、众包三者分层使用，是业界常见且可持续的做法。
- **众包优先**：正确。建议**优先做众包上报系统**——先有「用户上报价格 / 成功获药」的表单、审核与展示，再逐步接 API，这样既有差异化，又不依赖外部商务。
- **实时价格：多源 API 聚合**：正确。GoodRx / SingleCare 等 B2B 接入后，可按 ZIP、药品定时或按需拉取并缓存（如 15–60 分钟），与你的「价格引擎」目标一致。保险报销模拟（如 Change Healthcare / 原 PokitDok）通常面向 B2B 医疗机构，需商务与合规评估，可作为中长期增强。
- **货源：FDA + 药房库存映射**：FDA 同步是基础。**「药房库存状态检测 / 模拟查询」**需谨慎：对药房网站或内部系统做自动化查询或爬虫，很可能违反其 ToS 或计算机滥用相关法律；更稳妥的是通过**药房或 telehealth 官方提供的 Locator / 库存 API**（若有合作）或**仅依赖众包**做「哪里能买到」。
- **动态抓取（Scraping）复合药房定价**：概念上有用，但存在**合规与 ToS 风险**。若要做，建议仅针对明确允许爬虫的站点，或改为「人工定期采样 + 用户上报」。
- **供应链预测模型（ML + Red Alert）**：思路有价值。实现上建议**先有数据**（FDA 历史短缺 + 众包「有/无货」），再做简单规则或回归（如「过去 7 天该地区上报断货比例 > 70% → 提示风险」），最后再考虑更复杂的 ML。

### 7.4 实施顺序建议（与「众包优先」一致）

1. **先上众包**：用户上报「价格」+「成功获药地点/药房」；审核、展示、标注来源与时间；可选简单激励（如深度报告权限、积分）。
2. **再接官方与商业 API**：FDA 定时同步；GoodRx（或同类）价格 API 接入并缓存；政策类数据按日更新。
3. **最后增强预测与体验**：在众包 + FDA 数据基础上做「缺货风险」提示；若有合作方药房/telehealth 库存 API，再接入「库存雷达」并与地图结合。

这样既符合「不要自己生产数据、做超级连接器」的定位，又能在合规前提下把实时性与可预测性一步步做上去。
